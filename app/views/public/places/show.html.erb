<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm mb-4">
        <div class="card-body p-0">
          <% if @place.photos.attached? %>
            <div id="placePhotos" class="carousel slide" data-bs-ride="carousel">
              <div class="carousel-inner rounded">
                <% @place.photos.each_with_index do |photo, index| %>
                  <div class="carousel-item <%= 'active' if index == 0 %>">
                    <%= image_tag photo, class: 'd-block w-100', alt: '施設の写真' %>
                  </div>
                <% end %>
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#placePhotos" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#placePhotos" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
              </button>
            </div>
          <% else %>
            <p class="text-muted m-3">写真はまだ投稿されていません。</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>


  
  <!-- 施設名・カテゴリ・設備 -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-3"><%= @place.name %></h2>

      <% if @average_rating.present? %>
        <div class="d-flex align-items-center mb-3">
          <div class="rating me-2" data-score="<%= @average_rating %>"></div>
          <small class="text-muted">平均評価: <%= @average_rating %> / 5</small>
        </div>
      <% else %>
        <p class="text-muted mb-3">まだ評価はありません</p>
      <% end %>

      <p><strong>カテゴリ:</strong> <%= @place.category_i18n %></p>

      <div class="row">
        <div class="col-12 col-md-4 mb-2">
          <strong>授乳室:</strong>
            <% if @place.nursery %>
              <span class="text-success"><i class="fa-solid fa-check me-1"></i>あり</span>
            <% else %>
              <span class="text-secondary"><i class="fa-solid fa-xmark me-1"></i>なし</span>
            <% end %>
        </div>

      <div class="row">
        <div class="col-12 col-md-4 mb-2">
          <strong>おむつ交換台:</strong>
            <% if @place.diaper %>
              <span class="text-success"><i class="fa-solid fa-check me-1"></i>あり</span>
            <% else %>
              <span class="text-secondary"><i class="fa-solid fa-xmark me-1"></i>なし</span>
            <% end %>
        </div>  
          
        <div class="col-12 col-md-4 mb-2">
          <strong>幼児トイレ:</strong>
            <% if @place.kids_toilet %>
              <span class="text-success"><i class="fa-solid fa-check me-1"></i>あり</span>
            <% else %>
              <span class="text-secondary"><i class="fa-solid fa-xmark me-1"></i>なし</span>
            <% end %>
        </div>

        <div class="col-12 col-md-4 mb-2">
          <strong>ベビーカー対応:</strong>
            <% if @place.stroller %>
              <span class="text-success"><i class="fa-solid fa-check me-1"></i>あり</span>
            <% else %>
              <span class="text-secondary"><i class="fa-solid fa-xmark me-1"></i>なし</span>
            <% end %>
        </div>

        <div class="col-12 col-md-4 mb-2">
          <strong>木陰:</strong>
            <% if @place.shade %>
              <span class="text-success"><i class="fa-solid fa-check me-1"></i>あり</span>
            <% else %>
              <span class="text-secondary"><i class="fa-solid fa-xmark me-1"></i>なし</span>
            <% end %>
        </div>

        <div class="col-12 col-md-4 mb-2">
          <strong>ベンチ:</strong>
            <% if @place.bench %>
              <span class="text-success"><i class="fa-solid fa-check me-1"></i>あり</span>
            <% else %>
              <span class="text-secondary"><i class="fa-solid fa-xmark me-1"></i>なし</span>
            <% end %>
        </div>

        <div class="col-12 col-md-4 mb-2">
          <strong>遊具:</strong>
            <% if @place.playground %>
              <span class="text-success"><i class="fa-solid fa-check me-1"></i>あり</span>
            <% else %>
              <span class="text-secondary"><i class="fa-solid fa-xmark me-1"></i>なし</span>
            <% end %>
        </div>

        <div class="col-12 col-md-4 mb-2">
          <strong>エレベーター:</strong>
            <% if @place.elevator %>
              <span class="text-success"><i class="fa-solid fa-check me-1"></i>あり</span>
            <% else %>
              <span class="text-secondary"><i class="fa-solid fa-xmark me-1"></i>なし</span>
            <% end %>
        </div>

        <div class="col-12 col-md-4 mb-2">
          <strong>駐車場:</strong>
            <% if @place.parking %>
              <span class="text-success"><i class="fa-solid fa-check me-1"></i>あり</span>
            <% else %>
              <span class="text-secondary"><i class="fa-solid fa-xmark me-1"></i>なし</span>
            <% end %>
        </div>

        
      </div>
    </div>
  </div>

  <% if user_signed_in? && !guest_user? && @place.approved? %>
  <% @comments.each do |comment| %>
    <div class="card mb-3 shadow-sm w-100">
      <div class="card-body" style="background-color: #fff5f7;">
        <div class="d-flex justify-content-between flex-wrap">
          <div>
            <h6 class="text-muted">
              <i class="fa-solid fa-user"></i> <%= comment.user.nickname %>
            </h6>
            <p><%= comment.content %></p>

            <%= render 'public/likes/like_buttons', comment: comment, place: @place %>

            <div class="text-muted small mt-2">
              <%= l(comment.created_at, format: :short) %>
            </div>
          </div>
          <div class="text-end ms-3">
            <div class="rating mb-1" data-score="<%= comment.rating %>"></div>
            <span class="badge bg-light text-dark me-2">
              <i class="fa-solid fa-thumbs-up me-1"></i>
              <span id="like-count-<%= comment.id %>"><%= comment.likes.good.count %></span>
            </span>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- コメント投稿フォーム -->
  <div class="card shadow-sm w-100">
    <div class="card-body">
      <h5 class="mb-3">コメントを投稿する</h5>
      <%= form_with(model: [:public, @place, @comment], local: true) do |f| %>
        <div class="mb-3">
          <%= f.label :content, "コメント", class: "form-label" %>
          <%= f.text_area :content, rows: 3, class: "form-control" %>
        </div>

        <div class="mb-3">
          <label class="form-label">評価</label>
          <div id="star-rating" data-score="<%= @comment.rating || 0 %>"></div>
          <%= f.hidden_field :rating, id: "rating" %>
        </div>

        <%= f.submit "投稿する", class: "btn btn-outline-success px-4" %>
      <% end %>
    </div>
  </div>
<% end %>

<!-- ブックマーク -->
        


<!-- 住所・地図 -->
  <div class="row mt-4">
  <div class="col-12">
    <h5>施設所在地</h5>
    <p><strong>住所:</strong> <%= @place.address %></p>
    <a href="https://www.google.com/maps?q=<%= @place.latitude %>,<%= @place.longitude %>" 
      class="btn btn-outline-primary w-100 mb-3" target="_blank">
      <i class="fa-solid fa-map-location-dot me-1"></i>
      Googleマップで表示
    </a>
  </div>
</div>
      
<!-- 削除ボタン（オーナーのみ） -->
  <% if user_signed_in? && current_user == @place.user %>
    <div class="row">
      <div class="col-12">
        <%= button_to 'この施設を削除', public_place_path(@place),
              method: :delete, data: { confirm: '本当に削除しますか？' },
              class: 'btn btn-danger w-100' %>
      </div>
    </div>
  <% end %>

</div>

<script>
  // 投稿用
  document.addEventListener("turbolinks:load", () => {
  const target = document.getElementById("star-rating");

  if (target) {
    target.innerHTML = '';
    const score = parseFloat(target.dataset.score || 0);

    raty(target, {
      number: 5,
      starSize: 24,      
      starOn: '/assets/raty/star-on.png',
      starOff: '/assets/raty/star-off.png',
      starHalf: '/assets/raty/star-half.png',
      half: true,
      halfShow: true,
      click: (newScore) => {
        const input = document.getElementById("rating");
        if (input) input.value = newScore;
        }
    });
  }
  
  // 表示用
  
  
  document.querySelectorAll(".rating").forEach((elem) => {
    elem.innerHTML = '';
    const score = parseFloat(elem.dataset.score || 0);

    raty(elem, {
      score: score,
      readOnly: true, // コメント表示は読取専用
      
      starOn: '/assets/raty/star-on.png',
      starOff: '/assets/raty/star-off.png',
      starHalf: '/assets/raty/star-half.png',
      halfShow: true,
    });
  });
});
</script>